<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ReadSync ‚Äî Manage</title>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #111827;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */

        .header {
            color: #fff;
            text-align: center;
            margin-bottom: 18px;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: .2px;
            margin-bottom: 6px;
        }

        .header p {
            opacity: .9;
        }

        .authbar {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            color: #eef2ff;
            flex-wrap: wrap;
        }

        .btn {
            padding: 9px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .35);
            background: rgba(255, 255, 255, .95);
            color: #111827;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-danger {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .btn-primary {
            background: #667eea;
            border-color: #818cf8;
            color: #fff;
        }

        /* Controls */

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 14px auto 20px;
            max-width: 980px;
        }

        .controls input[type="search"],
        .controls select {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .35);
            background: rgba(255, 255, 255, .9);
            color: #111827;
            outline: none;
            min-width: 180px;
        }

        /* Layout / Panels */

        .panel {
            background: rgba(255, 255, 255, .96);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 28px rgba(0, 0, 0, .12);
            backdrop-filter: blur(8px);
        }

        .panel h2 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #0f172a;
        }

        .novels-grid {
            display: grid;
            gap: 14px;
        }

        .novel-card {
            background: #ffffff;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .10);
            transition: transform .2s ease, box-shadow .2s ease;
        }

        .novel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(0, 0, 0, .14);
        }

        .novel-header {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .novel-title {
            font-size: 1.15rem;
            font-weight: 800;
            color: #0f172a;
        }

        .novel-title a {
            color: inherit;
            text-decoration: none;
        }

        .novel-id {
            font-size: .85rem;
            color: #64748b;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }

        .status-pill {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .75rem;
            color: #fff;
            background: #111827;
        }

        .status-pill.reading {
            background: #0ea5e9;
        }

        .status-pill.completed {
            background: #10b981;
        }

        .status-pill.on-hold {
            background: #f59e0b;
        }

        .status-pill.dropped {
            background: #ef4444;
        }

        .muted {
            color: #64748b;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .error {
            display: none;
            background: #7f1d1d;
            color: #fff;
            border: 1px solid #fecaca;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .loading {
            text-align: center;
            padding: 48px 12px;
            color: #fff;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, .3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 14px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty {
            text-align: center;
            color: #fff;
            padding: 40px 10px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">

        <div class="header">
            <h1>üõ†Ô∏è ReadSync ‚Äî Manage</h1>
            <p>Change status or remove novels (requires API key)</p>

            <div class="authbar">
                <span id="whoami" class="muted">Not signed in</span>
                <button class="btn" onclick="setApiKey()">Set API key</button>
                <button class="btn" onclick="logout()">Logout</button>
                <a class="btn" href="/">‚Üê Back to Dashboard</a>
            </div>
        </div>

        <div id="error" class="error"></div>

        <div class="controls">
            <select id="statusFilter">
                <option value="">All statuses</option>
                <option value="reading">Reading</option>
                <option value="on-hold">On-hold</option>
                <option value="completed">Completed</option>
                <option value="dropped">Dropped</option>
            </select>

            <input id="q" type="search" placeholder="Filter by title‚Ä¶" />
            <button class="btn" onclick="reload()">Refresh ‚Üª</button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>Loading your novels‚Ä¶</div>
        </div>

        <div id="empty" class="empty">
            <h3>No novels found</h3>
            <p>Start reading on a device with the userscript and they‚Äôll show up here.</p>
        </div>

        <section class="panel" id="panel" style="display:none;">
            <h2>Manage Novels</h2>
            <div id="list" class="novels-grid"></div>
        </section>
    </div>

    <script>
        const API_BASE = '/api/v1';

        /* ---------- Auth ---------- */

        function getApiKey() {
            return localStorage.getItem('readsync_api_key') || '';
        }

        async function setApiKey() {
            const k = prompt('Enter your ReadSync API key:', getApiKey() || 'demo-api-key-12345');
            if (!k) return;
            try {
                const ok = await fetch(`${API_BASE}/auth/whoami?user_key=${encodeURIComponent(k)}&_t=${Date.now()}`, { cache: 'no-store' });
                if (!ok.ok) throw new Error();
                localStorage.setItem('readsync_api_key', k);
                reload();
            } catch {
                showError('That API key did not work.');
            }
        }

        function logout() {
            localStorage.removeItem('readsync_api_key');
            location.reload();
        }

        /* ---------- Fetch helper ---------- */

        async function getJSON(path, { method = 'GET', body = null, qs = {} } = {}) {
            const key = getApiKey();
            if (!key) throw new Error('NO_KEY');
            const url = new URL(path, location.origin);
            url.searchParams.set('user_key', key);
            url.searchParams.set('_t', Date.now().toString());
            for (const [k, v] of Object.entries(qs)) {
                if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
            }
            const res = await fetch(url.toString(), {
                method,
                headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' },
                cache: 'no-store',
                body: body ? JSON.stringify(body) : null
            });
            if (!res.ok) {
                let detail = '';
                try { const j = await res.json(); detail = j.error || j.detail || JSON.stringify(j); } catch { }
                throw new Error(`${res.status} ${res.statusText}${detail ? ' ‚Äì ' + detail : ''}`);
            }
            return res.json();
        }

        /* ---------- UI helpers ---------- */

        function showError(msg) {
            const el = document.getElementById('error');
            el.style.display = 'block';
            el.textContent = msg;
        }

        function clearError() {
            const el = document.getElementById('error');
            el.style.display = 'none';
            el.textContent = '';
        }

        /* ---------- Render ---------- */

        function render(list) {
            const grid = document.getElementById('list');
            grid.innerHTML = '';

            if (!list.length) {
                document.getElementById('empty').style.display = 'block';
                document.getElementById('panel').style.display = 'none';
                return;
            }

            document.getElementById('empty').style.display = 'none';
            document.getElementById('panel').style.display = 'block';

            for (const n of list) {
                const status = (n.status || 'reading').toLowerCase();
                const latest = n.latest_global;

                const card = document.createElement('div');
                card.className = 'novel-card';
                card.innerHTML = `
          <div class="novel-header">
            <div class="novel-title">
              <a href="${n.primary_url || '#'}" target="_blank" rel="noreferrer">${n.title}</a>
              <span class="status-pill ${status}">${status.toUpperCase()}</span>
            </div>
            <span class="novel-id">${n.novel_id}</span>
          </div>

          ${latest ? `
            <div class="muted">
              Last: <strong>${latest.chapter_token || 'Chapter'} ${latest.chapter_num}</strong>
              ‚Ä¢ ${Number(latest.percent).toFixed(1)}%
              ‚Ä¢ ${latest.device_label} ‚Ä¢ ${new Date(latest.ts).toLocaleString()}
            </div>
          ` : '<div class="muted">No recent progress</div>'}

          <div class="row">
            <button class="btn btn-primary" onclick="changeStatus('${n.novel_id}', '${status}')">Change Status</button>
            <button class="btn btn-danger" onclick="removeNovel('${n.novel_id}', false)">Soft Remove</button>
            <button class="btn btn-danger" onclick="removeNovel('${n.novel_id}', true)">HARD Delete</button>
            ${latest ? `<a class="btn" href="${latest.url}" target="_blank">Open</a>` : ''}
          </div>
        `;
                grid.appendChild(card);
            }
        }

        /* ---------- Actions ---------- */

        async function changeStatus(novelId, current) {
            const next = prompt(`Set status for ${novelId}\nreading | completed | on-hold | dropped`, current || 'reading');
            if (!next) return;
            const valid = new Set(['reading', 'completed', 'on-hold', 'dropped']);
            if (!valid.has(next)) { showError('Invalid status'); return; }
            try {
                await getJSON(`${API_BASE}/novels/${encodeURIComponent(novelId)}/status`, {
                    method: 'PUT',
                    body: { user_key: getApiKey(), status: next }
                });
                await reload(false);
            } catch (e) {
                showError('Failed to set status: ' + e.message);
            }
        }

        async function removeNovel(novelId, hard) {
            const msg = hard
                ? 'This will permanently delete snapshots & bookmarks for this novel. Type DELETE to confirm.'
                : 'This will hide the novel (status=removed) but keep your history. Type REMOVE to confirm.';
            const expect = hard ? 'DELETE' : 'REMOVE';
            const answer = prompt(msg, '');
            if (answer !== expect) return;

            try {
                await getJSON(`${API_BASE}/novels/${encodeURIComponent(novelId)}`, {
                    method: 'DELETE',
                    body: { user_key: getApiKey(), hard: !!hard }
                });
                await reload(false);
            } catch (e) {
                showError('Failed to remove: ' + e.message);
            }
        }

        /* ---------- Load ---------- */

        async function reload(showSpinner = true) {
            clearError();

            if (!getApiKey()) {
                await setApiKey();
                if (!getApiKey()) return;
            }

            if (showSpinner) {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('empty').style.display = 'none';
                document.getElementById('panel').style.display = 'none';
            }

            try {
                const who = await getJSON(`${API_BASE}/auth/whoami`);
                document.getElementById('whoami').textContent = `Signed in as: ${who.display_name || who.id}`;
            } catch { /* ignore */ }

            try {
                const status = document.getElementById('statusFilter').value;
                const novels = await getJSON(`${API_BASE}/novels`, { qs: { status } });

                // local filter
                const q = (document.getElementById('q').value || '').toLowerCase();
                const filtered = novels.filter(n => (n.title || '').toLowerCase().includes(q));

                render(filtered);
            } catch (e) {
                showError('Load failed: ' + e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        document.getElementById('statusFilter').addEventListener('change', () => reload(false));
        document.getElementById('q').addEventListener('input', () => reload(false));

        document.addEventListener('DOMContentLoaded', reload);
    </script>
</body>

</html>