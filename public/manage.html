<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ReadSync ‚Äî Manage</title>

    <!-- Favicons / PWA -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#0f172a" />

    <style>
        :root {
            --primary: #6366f1;
            --primary-soft: rgba(99, 102, 241, 0.14);
            --primary-strong: rgba(99, 102, 241, 0.4);
            --bg: #020617;
            --bg-elevated: #020617;
            --bg-card: #0f172a;
            --bg-row: #020617;
            --bg-row-alt: #020617;
            --bg-hover: #1e293b;
            --border-subtle: #1e293b;
            --border-strong: #334155;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --cover-fallback: #111827;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: radial-gradient(circle at top, #1f2933 0, #020617 55%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 16px;
        }

        .header h1 {
            font-size: 2.1rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--text-secondary);
        }

        .auth {
            margin: 14px auto 18px;
            max-width: 680px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            align-items: center;
        }

        .auth input {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-primary);
            outline: none;
        }

        .btn {
            padding: 9px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .btn-danger {
            background: var(--danger);
            border-color: var(--danger);
            color: #fff;
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 16px;
        }

        .panel h2 {
            font-size: 1.05rem;
            margin-bottom: 10px;
            color: #0f172a;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 8px 0 14px;
            align-items: center;
        }

        .controls select,
        .controls input[type="search"] {
            padding: 9px 12px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: #fff;
            min-width: 160px;
        }

        .novels-grid {
            display: grid;
            gap: 14px;
        }

        .novel-card {
            background: #000000;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .10);
        }

        .novel-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .novel-title {
            font-weight: 800;
        }

        .novel-id {
            font-size: .85rem;
            color: #3cb2ad;
            background: #000000;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }

        .status-pill {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .75rem;
            color: #fff;
            background: #111827;
        }

        .status-pill.reading {
            background: #0ea5e9;
        }

        .status-pill.completed {
            background: #3cb2ad;
        }

        .status-pill.on-hold {
            background: #f59e0b;
        }

        .status-pill.dropped {
            background: #ef4444;
        }

        .status-pill.removed {
            background: #6b7280;
        }

        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
            align-items: center;
        }

        .error {
            display: none;
            background: #7f1d1d;
            color: #fff;
            border: 1px solid #fecaca;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .loading {
            text-align: center;
            color: #fff;
            padding: 40px 10px;
        }

        .empty {
            text-align: center;
            color: #fff;
            padding: 36px 10px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è ReadSync ‚Äî Manage</h1>
            <p>Change status or remove novels (API key required)</p>
        </div>

        <div class="auth">
            <input id="apiKey" type="password" placeholder="Enter your API key‚Ä¶" />
            <button class="btn btn-primary" id="connectBtn">Connect</button>
            <a class="btn" href="/">‚Üê Dashboard</a>
        </div>

        <div id="who" style="text-align:center; color:#eef2ff; margin-bottom:8px;"></div>
        <div id="error" class="error"></div>

        <section class="panel" id="panel" style="display:none;">
            <h2>Manage Novels</h2>

            <div class="controls">
                <select id="statusFilter">
                    <option value="">All statuses</option>
                    <option value="reading">Reading</option>
                    <option value="on-hold">On-hold</option>
                    <option value="completed">Completed</option>
                    <option value="dropped">Dropped</option>
                    <option value="removed">Removed</option>
                </select>
                <input id="q" type="search" placeholder="Filter by title‚Ä¶" />
                <button class="btn" id="refreshBtn">Refresh ‚Üª</button>
            </div>

            <div id="loading" class="loading" style="display:none;">Loading‚Ä¶</div>
            <div id="empty" class="empty">No novels found.</div>
            <div id="list" class="novels-grid"></div>
        </section>
    </div>

    <script src="/js/shared.js"></script>
    <script>
        // Functions now imported from shared.js:
        // - getApiKey(), setApiKey(), hasApiKey()
        // - getJSON()
        // - showError()
        // - formatTimestamp() (replaces fmtAgo)
        // - $() shorthand

        // ----- auth flow
        async function connect() {
            const key = ($('apiKey').value || '').trim();
            if (!key) return showError('Please enter your API key.');
            try {
                const who = await getJSON('auth/whoami', { qs: { user_key: key } });
                setApiKey(key);
                $('who').textContent = `Signed in as: ${who.display_name || who.id}`;
                $('panel').style.display = 'block';
                reload(true);
            } catch (e) {
                showError('Login failed: ' + e.message);
            }
        }

        // ----- render
        function render(list) {
            const grid = $('list');
            grid.innerHTML = '';

            if (!list.length) {
                $('empty').style.display = 'block';
                return;
            }
            $('empty').style.display = 'none';

            for (const n of list) {
                const status = (n.status || 'reading').toLowerCase();
                const latest = n.latest_global;

                const card = document.createElement('div');
                card.className = 'novel-card';
                card.innerHTML = `
          <div class="novel-header">
            <div class="novel-title">
              ${n.title || n.novel_id}
              <span class="status-pill ${status}">${status.toUpperCase()}</span>
            </div>
            <span class="novel-id">${n.novel_id}</span>
          </div>

          <div style="color:#64748b;">
            ${latest ? `
              Last: <strong>${latest.chapter_token || 'Chapter'} ${Number(latest.chapter_num) || 0}</strong>
              ‚Ä¢ ${Number(latest.percent || 0).toFixed(1)}%
              ‚Ä¢ ${latest.device_label || ''} ‚Ä¢ ${formatTimestamp(latest.ts)}
            ` : 'No recent progress'}
          </div>

          <div class="row">
            <button class="btn btn-primary"
              onclick="changeStatus('${encodeURIComponent(n.novel_id)}','${status}')">Change Status</button>
            <button class="btn btn-danger"
              onclick="removeNovel('${encodeURIComponent(n.novel_id)}', false)">Soft Remove</button>
            <button class="btn btn-danger"
              onclick="removeNovel('${encodeURIComponent(n.novel_id)}', true)">HARD Delete</button>
            ${n.primary_url ? `<a class="btn" href="${n.primary_url}" target="_blank" rel="noreferrer">Open</a>` : ''}
          </div>
        `;
                grid.appendChild(card);
            }
        }

        // ----- FIXED actions on novels
        async function changeStatus(encodedNovelId, current) {
            const novelId = decodeURIComponent(encodedNovelId);
            const next = prompt(
                `Set status for ${novelId}\nreading | completed | on-hold | dropped | removed`,
                current || 'reading'
            );
            if (!next) return;
            const valid = new Set(['reading', 'completed', 'on-hold', 'dropped', 'removed']);
            if (!valid.has(next)) return showError('Invalid status');

            try {
                await getJSON(`novels/${encodeURIComponent(novelId)}/status`, {
                    method: 'PUT',
                    body: { status: next }
                });
                await reload(false);
            } catch (e) {
                showError('Failed to set status: ' + e.message);
            }
        }

        async function removeNovel(encodedNovelId, hard) {
            const novelId = decodeURIComponent(encodedNovelId);
            const msg = hard
                ? 'This permanently deletes snapshots & bookmarks for this novel.\nType DELETE to confirm.'
                : 'This hides the novel (status=removed) but keeps history.\nType REMOVE to confirm.';
            const expect = hard ? 'DELETE' : 'REMOVE';
            const answer = prompt(msg, '');
            if (answer !== expect) return;
            try {
                await getJSON(`novels/${encodeURIComponent(novelId)}`, {
                    method: 'DELETE',
                    body: { hard: !!hard }
                });
                await reload(false);
            } catch (e) {
                showError('Failed to remove: ' + e.message);
            }
        }

        // ----- data load  
        async function reload(showSpinner = true) {
            $('loading').style.display = showSpinner ? 'block' : 'none';
            try {
                const status = $('statusFilter').value;
                const data = await getJSON('novels', { qs: { status } });
                // API returns { novels: [...], pagination: {...} }
                const novels = Array.isArray(data) ? data : (data.novels || []);
                const q = ($('q').value || '').toLowerCase();
                const filtered = novels.filter(n => (n.title || '').toLowerCase().includes(q));
                render(filtered);
            } catch (e) {
                showError('Load failed: ' + e.message);
            } finally {
                $('loading').style.display = 'none';
            }
        }

        // ----- wire up
        $('connectBtn').addEventListener('click', connect);
        $('refreshBtn').addEventListener('click', () => reload(false));
        $('statusFilter').addEventListener('change', () => reload(false));
        $('q').addEventListener('input', () => reload(false));

        // auto-connect if key saved
        const saved = getApiKey();
        if (saved) { $('apiKey').value = saved; connect(); }
    </script>
</body>

</html>